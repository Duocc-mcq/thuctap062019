# Cấu hình Prometheus gửi tin nhắn về Slack 
## 1.Chuẩn bị 
- Môi trường 
  - Node 1(server prometheus): 192.168.30.111
  - Node 2 (node exporter): 192.168.30.112
## 2. Cài đặt Alert-manager 
- Thực hiện trên node server prometheus 
```
useradd --no-create-home --shell /bin/false alertmanager
cd /opt
wget https://github.com/prometheus/alertmanager/releases/download/v0.21.0/alertmanager-0.21.0.linux-amd64.tar.gz
tar xvf alertmanager-0.21.0.linux-amd64.tar.gz

mv alertmanager-0.21.0.linux-amd64/alertmanager /usr/local/bin/
mv alertmanager-0.21.0.linux-amd64/amtool /usr/local/bin/

chown alertmanager:alertmanager /usr/local/bin/alertmanager
chown alertmanager:alertmanager /usr/local/bin/amtool

rm -rf alertmanager-0.21.0.linux-amd64*

mkdir /etc/alertmanager
chown alertmanager:alertmanager /etc/alertmanager
```
## 3. Cấu hình cảnh báo qua slack 
- Cấu hình file `/etc/alertmanager/alertmanager.yml`
```
global:
 resolve_timeout: 1m
 slack_api_url: 'https://hooks.slack.com/services/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'

route:
 receiver: 'slack'

receivers:
 - name: 'slack'
   slack_configs:
     - api_url: 'https://hooks.slack.com/services/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'
       channel: '#alert-manager'
       send_resolved: true
```
- Thay `api_url` và `channel` với slack của bạn sao cho phù hợp 
- Cấp quyền cho file cấu hình 
```
chown alertmanager:alertmanager /etc/alertmanager/alertmanager.yml
```
- Tạo rule Alert 
```
touch /etc/prometheus/alert.rules.yml
chown prometheus:prometheus /etc/prometheus/alert.rules.yml
cat <<EOF > /etc/prometheus/alert.rules.yml
groups:
- name: Instances
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 10s
    labels:
      severity: page
    # Prometheus templates apply here in the annotation and label fields of the alert.
    annotations:
      description: '{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 10 s.'
      summary: 'Instance {{ $labels.instance }} down'
EOF
chown prometheus:prometheus /etc/prometheus/alert.rules.yml
```
- Rule này sẽ check khi client bị down với  thời gian 10s 
- Để kiểm tra các rule thì ta sử dụng lệnh 
```
promtool check rules /etc/prometheus/alert.rules.yml
```
- Chỉnh sửa file vào file `/etc/prometheus/prometheus.yml`
```
global:
  scrape_interval: 10s

scrape_configs:
  - job_name: 'prometheus_master'
    scrape_interval: 5s
    static_configs:
      - targets: ['192.168.30.111:9090']
  - job_name: 'duoc-ngon-zai'
    scrape_interval: 5s
    static_configs:
      - targets: ['192.168.30.112:9100']

rule_files:
  - alert.rules.yml
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - 192.168.30.111:9093
```
- Cấu hình file `/etc/systemd/system/prometheus.service`
- Thêm vào dòng
```
    --web.external-url=http://ip_alertmanager
```
- Chạy Alert dưới dạng System 
```
cat <<EOF > /etc/systemd/system/alertmanager.service
[Unit]
Description=Alertmanager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
WorkingDirectory=/etc/alertmanager/
ExecStart=/usr/local/bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --web.external-url http://ip_alertmanager:9093

[Install]
WantedBy=multi-user.target
EOF
```
- Khởi động lại service 
```
systemctl daemon-reload
systemctl restart prometheus
systemctl start alertmanager
systemctl enable alertmanager
```
## 3. Test môi trường 
- Trên node exporter thử down service 
```
systemctl stop node_exporter.service
```
- Thông báo được gửi về slack 
- ![Atom](https://i.imgur.com/mG0R5u9.png)
